name: ðŸ§ª CI/CD Pipeline
on:
  push:
    branches:
      - master
      - 'feature/**'
      - 'releases/**'
    tags-ignore:
      - v1.0.0
  pull_request:
    branches: [ master ]
jobs:
  lint:
    if: github.event.pull_request.draft == false
    timeout-minutes: 10
    runs-on: ubuntu-latest
    name: Code Quality (Lint & Validate)
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6
    
    - name: ðŸ˜ Setup PHP 8.4
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, dom, fileinfo
        coverage: none
        tools: composer:v2

    - name: ðŸ“¦ Cache Composer packages
      uses: actions/cache@v5
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: ðŸ“¦ Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: âœ… Validate composer files
      run: composer validate --strict

    - name: ðŸŽ¨ Check coding standards
      run: composer run cs

    - name: ðŸ” Run PHPStan analysis
      run: composer run phpstan

    - name: ðŸ“‹ Generate summary
      if: always()
      run: |
        echo "## ðŸŽ¨ Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **PHP Version:** 8.4" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Composer validation:** Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Coding standards:** Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **PHPStan analysis:** Passed" >> $GITHUB_STEP_SUMMARY

  test:
    if: github.event.pull_request.draft == false
    timeout-minutes: 20
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            php-versions: '8.2'
          - os: ubuntu-latest
            php-versions: '8.3'
          - os: ubuntu-latest
            php-versions: '8.4'
          - os: windows-latest
            php-versions: '8.4'
          - os: macOS-latest
            php-versions: '8.4'
    runs-on: ${{ matrix.os }}
    name: Tests - PHP ${{ matrix.php-versions }} (${{ matrix.os }})
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6
      
    - name: ðŸ˜ Setup PHP ${{ matrix.php-versions }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
        extensions: mbstring, dom, fileinfo
        ini-values: memory_limit=256M
        coverage: ${{ matrix.os == 'ubuntu-latest' && matrix.php-versions == '8.4' && 'xdebug' || 'none' }}
        tools: composer:v2

    - name: ðŸ’¾ Cache ImageMagick (Windows)
      if: runner.os == 'Windows'
      id: cache-imagemagick-windows
      uses: actions/cache@v5
      with:
        path: C:\ProgramData\chocolatey\lib\imagemagick
        key: ${{ runner.os }}-imagemagick-${{ hashFiles('.github/workflows/php.yml') }}

    - name: ðŸ“¦ Cache Composer packages
      uses: actions/cache@v5
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ matrix.php-versions }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-${{ matrix.php-versions }}-
          ${{ runner.os }}-php-

    - name: ðŸŽ¨ Install ImageMagick
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y imagemagick
        elif [ "$RUNNER_OS" == "macOS" ]; then
          # Always reinstall to ensure dependencies are present
          brew install imagemagick
        elif [ "$RUNNER_OS" == "Windows" ]; then
          # Check if already installed
          if command -v magick &> /dev/null; then
            echo "ImageMagick already installed"
          elif [ "${{ steps.cache-imagemagick-windows.outputs.cache-hit }}" != "true" ]; then
            choco install imagemagick -y --no-progress
          fi
        fi
      shell: bash
      continue-on-error: false

    - name: ðŸ“¦ Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: âœ… Verify ImageMagick installation
      id: verify-imagemagick
      run: |
        if command -v magick &> /dev/null; then
          magick -version
        elif command -v convert &> /dev/null; then
          convert -version
        else
          echo "ImageMagick not found!"
          exit 1
        fi
      shell: bash
      continue-on-error: true

    - name: ðŸ”§ Set ImageMagick path (Linux/macOS)
      if: runner.os != 'Windows' && success()
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          echo "IMAGEMAGICK_PATH=/usr/bin/" >> $GITHUB_ENV
        elif [ "$RUNNER_OS" == "macOS" ]; then
          MAGICK_PATH=$(dirname $(which magick))
          echo "IMAGEMAGICK_PATH=${MAGICK_PATH}/" >> $GITHUB_ENV
        fi
      shell: bash

    - name: ðŸ”§ Set ImageMagick path (Windows)
      if: runner.os == 'Windows'
      run: |
        $magickPath = (Get-Command magick).Source | Split-Path
        echo "IMAGEMAGICK_PATH=$magickPath/" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: ðŸ§ª Run unit tests (without coverage)
      if: matrix.os != 'ubuntu-latest' || matrix.php-versions != '8.4'
      run: composer run unit -- --no-coverage

    - name: ðŸ§ª Run unit tests (with coverage)
      if: matrix.os == 'ubuntu-latest' && matrix.php-versions == '8.4'
      run: composer run unit
      env:
        XDEBUG_MODE: coverage

    - name: ðŸ“Š Upload coverage report
      if: matrix.os == 'ubuntu-latest' && matrix.php-versions == '8.4'
      uses: actions/upload-artifact@v6
      with:
        name: coverage-ubuntu-latest-8.4
        path: coverage/

    - name: ðŸ“‹ Generate test summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results - PHP ${{ matrix.php-versions }} on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| PHP Version | ${{ matrix.php-versions }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | ${{ matrix.os }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ImageMagick | ${{ steps.verify-imagemagick.outcome == 'success' && 'âœ… Installed' || 'âš ï¸ Check required' }} |" >> $GITHUB_STEP_SUMMARY
      shell: bash
        
    - name: ðŸ“‹ Add coverage info to summary
      if: always() && matrix.os == 'ubuntu-latest' && matrix.php-versions == '8.4'
      run: echo "| Coverage | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
      shell: bash
      
    - name: ðŸ“‹ Add coverage skipped to summary  
      if: always() && (matrix.os != 'ubuntu-latest' || matrix.php-versions != '8.4')
      run: echo "| Coverage | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
      shell: bash

  docs:
    name: Build Documentation
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6
    
    - name: ðŸŸ¢ Setup Node.js 20
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ðŸ“š Build documentation site
      run: |
        npm install
        npm run docs:build 

    - name: ðŸ’¾ Save documentation artifact
      uses: actions/upload-artifact@v6
      with:
        name: docs
        path: docs/.vuepress/dist

    - name: ðŸ“‹ Generate documentation summary
      if: always()
      run: |
        echo "## ðŸ“š Documentation Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Documentation site generated successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Tool:** VuePress 2.0" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version:** 20" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to GitHub Pages
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    needs: [docs, test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        ref: gh-pages
        persist-credentials: false
        fetch-depth: 0
        
    - name: ðŸ—‘ï¸ Remove old coverage
      run: if [ -d ./coverage ] ; then rm -r ./coverage; fi
      
    - name: ðŸ“¥ Download coverage report
      uses: actions/download-artifact@v7
      with:
        name: coverage-ubuntu-latest-8.4
        path: coverage
        
    - name: ðŸ“¥ Download documentation
      uses: actions/download-artifact@v7
      with:
        name: docs
        path: .
        
    - name: ðŸ“„ Ensure .nojekyll exists
      run: |
        if [ ! -f .nojekyll ]; then
          touch .nojekyll
        fi
        
    - name: ðŸ“ Commit changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git commit -m "Updated documentation"
        
    - name: ðŸš€ Push to GitHub Pages
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
    - name: ï¿½ï¿½ï¿½ Generate publish summary
      if: always()
      run: |
        echo "## ï¿½ï¿½ï¿½ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ï¿½ï¿½ï¿½ **Site URL:** https://localgod.github.io/karla/" >> $GITHUB_STEP_SUMMARY
        echo "ï¿½ï¿½ï¿½ **Coverage Report:** https://localgod.github.io/karla/coverage/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Deployment completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
