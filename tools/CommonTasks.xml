<project name="CommonTasks">
	<property name="build" value="build" />
	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${basedir}/tools/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	
	<!-- Import aditional tasks -->
	<path id="project.classpath">
		<fileset dir="${basedir}/tools">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- ================================= target: init ================================== -->
	<target name="init" description="Create requried folders for build">
		<mkdir dir="${build}/logs" />
		<mkdir dir="${build}/api" />
		<mkdir dir="${build}/coverage" />
		<mkdir dir="${build}/php-code-browser" />
		<mkdir dir="${build}/pdepend" />
	</target>

	<!-- ================================= target: cleanup =============================== -->
	<target name="clean" depends="" description="Clean up in build folder">
		<delete dir="${build}" />
	</target>

	<!-- ================================= target: basebuild ============================= -->
	<target name="build" depends="checkphp, clean, init, phpunit, phpmd, phpcs" description="Base build">
	</target>

	<!-- ================================= target: basebuild ============================= -->
	<target name="travisbuild" depends="checkphp, clean, init, phpunit, phpcs" description="Build on Travis">
	</target>
	
	<!-- ================================= target: build ================================= -->
	<target name="buildall" depends="build" description="Build">
		<antcall target="phploc" />
		<antcall target="pdepend" />
		<antcall target="phpdoc" />
	</target>

	<!-- ================================= target: ccbuild =============================== -->
	<target name="ccbuild" depends="build" description="Build on cruisecontrol">
		<antcall target="phpcpd" />
		<antcall target="phplocCC" />
		<antcall target="phpcb" />
		<antcall target="phpdoc" />
	</target>

	<!-- ================================= target: checkphp ============================== -->
	<target name="checkphp" description="Check php syntax">
		<apply executable="php" failonerror="true">
			<arg value="-l" />
			<path refid="checkphp.fileset" />
		</apply>
	</target>

	<!-- ================================= target: phpunit =============================== -->
	<target name="phpunit" description="Run phpunit tests">
		<delete dir="${basedir}/${build}/logs" />
		<mkdir dir="${basedir}/${build}/logs" />
		<exec executable="phpunit" dir="${phpunit.testdir}" failonerror="true">
			<arg line="--configuration phpunit.xml" />
		</exec>
	</target>

	<!-- ================================= target: phpcodebrowser =============================== -->
	<target name="phpcb" description="Aggregate tool output with PHP_CodeBrowser">
		<exec executable="phpcb">
			<arg line="--log ${basedir}/${build}/logs
			--source ${basedir}
			--output ${basedir}/build/php-code-browser" />
		</exec>
	</target>

	<!-- ================================= target: phpmd ================================= -->
	<target name="phpmd" description="Php mess detector">
		<if>
			<equals arg1="${phpmd.exclude}" arg2="" />
			<then>
				<exec executable="phpmd" dir="${basedir}">
					<arg line="${phpmd.include} html ${phpmd.rules}" />
					<arg line="--reportfile ${basedir}/${build}/logs/pmd.html" />
					<arg line="--suffixes php" />
				</exec>
				<exec executable="phpmd" dir="${basedir}">
					<arg line="${phpmd.include} xml ${phpmd.rules}" />
					<arg line="--reportfile ${basedir}/${build}/logs/pmd.xml" />
					<arg line="--suffixes php" />
				</exec>
			</then>
			<else>
				<exec executable="phpmd" dir="${basedir}">
					<arg line="${phpmd.include} html ${phpmd.rules}" />
					<arg line="--reportfile ${basedir}/${build}/logs/pmd.html" />
					<arg line="--suffixes php" />
					<arg line="--exclude ${phpmd.exclude}" />
				</exec>
				<exec executable="phpmd" dir="${basedir}">
					<arg line="${phpmd.include} xml ${phpmd.rules}" />
					<arg line="--reportfile ${basedir}/${build}/logs/pmd.xml" />
					<arg line="--suffixes php" />
					<arg line="--exclude ${phpmd.exclude}" />
				</exec>
			</else>
		</if>
		<exec executable="grep" outputproperty="phpmd.result">
			<arg line="--max-count=1" />
			<arg line="'file'" />
			<arg line="${basedir}/${build}/logs/pmd.xml" />
		</exec>
		<if>
			<equals arg1="${phpmd.result}" arg2="" />
			<then>
				<echo>PHPMD reported no violations</echo>
			</then>
			<else>
				<if>
					<equals arg1="${phpmd.failonerror}" arg2="true" />
					<then>
						<fail message="PHPMD reported violations" />
					</then>
				</if>
			</else>
		</if>
	</target>

	<!-- ================================= target: phpcs ================================ -->
	<target name="phpcs" description="Php codesniffer utility">
		<if>
			<equals arg1="${phpcs.exclude}" arg2="" />
			<then>
				<exec dir="${basedir}" executable="phpcs" output="${basedir}/${build}/logs/checkstyle.xml">
					<arg line="--report=checkstyle" />
					 <arg line="--standard=${basedir}/tools/Karla" />
					<arg line="--extensions=php" />
					<arg line="--tab-width=4" />
					<arg line="-n" />
					<arg line="${phpcs.include}" />
				</exec>
			</then>
			<else>
				<exec dir="${basedir}" executable="phpcs" output="${basedir}/${build}/logs/checkstyle.xml">
					<arg line="--report=checkstyle" />
					 <arg line="--standard=${basedir}/tools/Karla" />
					<arg line="--extensions=php" />
					<arg line="--ignore=${phpcs.exclude}" />
					<arg line="--tab-width=4" />
					<arg line="-n" />
					<arg line="${phpcs.include}" />
				</exec>
			</else>
		</if>
		<xslt in="${basedir}/${build}/logs/checkstyle.xml" out="${basedir}/${build}/logs/checkstyle.html" style="tools/checkstylereport/codestyle.xsl">
		</xslt>
		<copy file="${basedir}/tools/checkstylereport/cs.css" tofile="${basedir}/${build}/logs/cs.css" />
		<exec executable="grep" outputproperty="phpcs.result">
			<arg line="--max-count=1" />
			<arg line="'error'" />
			<arg line="${basedir}/${build}/logs/checkstyle.xml" />
		</exec>
		<if>
			<equals arg1="${phpcs.result}" arg2="" />
			<then>
				<echo>PHPCS reported no violations</echo>
			</then>
			<else>
				<if>
					<equals arg1="${phpcs.failonerror}" arg2="true" />
					<then>
						<fail message="PHPCS reported violations" />
					</then>
				</if>
			</else>
		</if>
	</target>

	<!-- ================================= target: phpcpd ================================ -->
	<target name="phpcpd" description="Php copy-paste detection">
		<if>
			<equals arg1="${phpcpd.exclude}" arg2="" />
			<then>
				<exec executable="phpcpd" failonerror="${phpcpd.failonerror}">
					<arg line="--log-pmd ${basedir}/${build}/logs/pmd-cpd.xml" />
					<arg line="${phpcpd.include}" />
				</exec>
			</then>
			<else>
				<exec executable="phpcpd" failonerror="${phpcpd.failonerror}">
					<arg line="--log-pmd ${basedir}/${build}/logs/pmd-cpd.xml" />
					<arg line="--exclude ${phpcpd.exclude}" />
					<arg line="${phpcpd.include}" />
				</exec>
			</else>
		</if>
	</target>

	<!-- ================================= target: pdepend =============================== -->
	<target name="pdepend" description="Generate jdepend.xml and software metrics charts using PHP_Depend">
		<if>
			<equals arg1="${phpdepend.exclude}" arg2="" />
			<then>
				<exec executable="pdepend">
					<arg line="--jdepend-xml=${basedir}/${build}/logs/jdepend.xml" />
					<arg line="--jdepend-chart=${basedir}/${build}/pdepend/10-dependencies.svg" />
					<arg line="--overview-pyramid=${basedir}/${build}/pdepend/11-overview-pyramid.svg" />
					<arg line="${phpdepend.include}" />
				</exec>
			</then>
			<else>
				<exec executable="pdepend">
					<arg line="--jdepend-xml=${basedir}/${build}/logs/jdepend.xml" />
					<arg line="--jdepend-chart=${basedir}/${build}/pdepend/10-dependencies.svg" />
					<arg line="--overview-pyramid=${basedir}/${build}/pdepend/11-overview-pyramid.svg" />
					<arg line="--ignore=${phpdepend.include}" />
					<arg line="${phpdepend.exclude}" />
				</exec>
			</else>
		</if>
	</target>

	<!-- ================================= target: phpdoc ================================ -->
	<target name="phpdoc" description="Phpdoc utility">
		<delete dir="${basedir}/${build}/api" />
		<mkdir dir="${basedir}/${build}/api" />

		<if>
			<equals arg1="${phpdoc.exclude}" arg2="" />
			<then>
				<if>
					<equals arg1="${phpdoc.include.file}" arg2="" />
					<then>
						<exec dir="${basedir}" executable="phpdoc" failonerror="true">
							<arg line="--directory ${phpdoc.include.dir}" />
							<arg line="--sourcecode" />
							<arg line="--defaultpackagename ${modulename}" />
							<arg line="--title 'Phpdoc for ${ant.project.name}'" />
							<arg line="--target ${basedir}/${build}/api" />
						</exec>
					</then>
					<else>
						<exec dir="${basedir}" executable="phpdoc" failonerror="true">
							<arg line="--directory ${phpdoc.include.dir}" />
							<arg line="--sourcecode" />
							<arg line="--title 'Phpdoc for ${ant.project.name}'" />
							<arg line="--defaultpackagename ${modulename}" />
							<arg line="--target ${basedir}/${build}/api" />
							<arg line="--filename ${phpdoc.include.file}" />
						</exec>
					</else>
				</if>
			</then>
			<else>
				<if>
					<equals arg1="${phpdoc.include.file}" arg2="" />
					<then>
						<exec dir="${basedir}" executable="phpdoc" failonerror="true">
							<arg line="--directory ${phpdoc.include.dir}" />
							<arg line="--sourcecode" />
							<arg line="--title 'Phpdoc for ${ant.project.name}'" />
							<arg line="--defaultpackagename ${modulename}" />
							<arg line="--target ${basedir}/${build}/api" />
							<arg line="--ignore ${phpdoc.exclude}" />
						</exec>
					</then>
					<else>
						<exec dir="${basedir}" executable="phpdoc" failonerror="true">
							<arg line="--directory ${phpdoc.include.dir}" />
							<arg line="--sourcecode" />
							<arg line="--title 'Phpdoc for ${ant.project.name}'" />
							<arg line="--defaultpackagename ${modulename}" />
							<arg line="--target ${basedir}/${build}/api" />
							<arg line="--filename ${phpdoc.include.file}" />
							<arg line="--ignore ${phpdoc.exclude}" />
						</exec>
					</else>
				</if>
			</else>
		</if>
	</target>

	<!-- ================================= target: phploc ================================= -->
	<target name="phploc" description="Generate phploc.xml">
		<if>
			<equals arg1="${phploc.exclude}" arg2="" />
			<then>
				<exec executable="phploc">
					<arg line="--log-xml ${basedir}/build/logs/phploc.xml" />
					<arg line="${phploc.include}" />
				</exec>
			</then>
			<else>
				<exec executable="phploc">
					<arg line="--log-xml ${basedir}/build/logs/phploc.xml" />
					<arg line="--exclude ${phploc.exclude}" />
					<arg line="${phploc.include}" />
				</exec>
			</else>
		</if>
	</target>

	<!-- ================================= target: phplocCC ================================= -->
	<target name="phplocCC" description="Generate phploc.csv">
		<if>
			<equals arg1="${phploc.exclude}" arg2="" />
			<then>
				<exec executable="phploc">
					<arg line="--log-csv ${basedir}/build/logs/phploc.csv" />
					<arg line="${phploc.include}" />
				</exec>
			</then>
			<else>
				<exec executable="phploc">
					<arg line="--log-csv ${basedir}/build/logs/phploc.csv" />
					<arg line="--exclude ${phploc.exclude}" />
					<arg line="${phploc.include}" />
				</exec>
			</else>
		</if>
	</target>
</project>